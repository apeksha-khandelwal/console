# tectonic-licensing

This repository contains re-usable packages that support, decoding and encoding Tectonic Licenses, as well as enforcing Tectonic licenses.

## license

Contains logic to decode and encode licenses. Also has some utility functions to get RSA public and private keys from a string PEM encoded contents.

## teckubelicense (tectonic-kubernetes directory)

Contains the logic to actually determine what entitlements and enforcements are contained within a license, for the Tectonic product.

# license-cli

There is a command line tool in `cmd/license-cli` to assist with encoding and decoding license files.
You can run it using `go run cmd/license-cli` or building it:

```
go build ./cmd/license-cli
./license-cli -h
```

Useful examples:

Decode the license used in unit-tests:

```
./license-cli -decode -public-key license/test-signing-key.pub -file license/test-license.txt
```

Create an new license, given a decoded license output:

Step 1, decode the license, and save the output

```
./license-cli -decode -public-key license/test-signing-key.pub -file license/test-license.txt > decoded-license.json
```

Optional step: You can edit decoded-license.json, as long as it conforms to the `License` struct defined in `license/license.go`

Step 2, re-encode the license with your private key (using the key used in unit tests here as an example):

```
./license-cli -encode -private-key license/fake-license-signing-key.key -file decoded-license.json
```

## Using the example licenses

There are a number of example licenses in the `fixture` directory.
These licenses were generated using https://account-staging.tectonic.com using the staging signing key.

If you want to view the licenses, we can use the license-cli to view their contents using the built-in public keys (via the `-use-tectonic-keys` modifier flag):

```
./license-cli -decode -use-tectonic-keys -public-key staging -file free-and-legacy-tectonic-bypass-enforcement-license-staging.txt
```

If you wanted to convert that license into a production license, follow the [instructions below to get the production private key](#where-do-i-get-the-keys-used-to-sign-licenses) , and run the following command:

```
./license-cli -decode -use-tectonic-keys -public-key staging -file fixtures/free-and-legacy-tectonic-bypass-enforcement-license-staging.txt > license-decoded.json
./license-cli -encode -use-tectonic-keys -private-key $SECURE_REPO/prod/tectonic-signing-key.prod.pem.txt -file license-decoded.json > new-production-license.txt
```

And to validate that worked, we decode it using the public key:

```
./license-cli -decode -use-tectonic-keys -public-key production -file new-production-license.txt
```

# Where do I get the keys used to sign licenses?

We currently sign licenses using 2048 bit RSA keys generated by openssl.
These RSA keypairs are used to sign licenses by https://account.tectonic.com and https://account-staging.tectonic.com are located in the [secure repo](https://github.com/coreos-inc/secure), under the prod directory.
If you want to create your own license using the private keys used in staging or production, follow the instructions below to get them.

To get the files you must decrypt the `prod` directory in the secure repo:

Set the path to your secure repo via a `$SECURE_REPO` variable:

```
SECURE_REPO=~/src/secure
```

Decrypt the folder

```
cd "$SECURE_REPO"
./handler.py -d -s prod
```

The keys are the following files:
```
prod/tectonic-signing-key.prod.pem.txt
prod/tectonic-signing-key.prod.pub.txt
prod/tectonic-signing-key.staging.pem.txt
prod/tectonic-signing-key.staging.pub.txt
```

These keys can then be used to generate your own licenses.
The public keys are already contained in `license/keys.go` to make using the license library easier, but the private keys cannot be included as that could easily cause them to leak into binaries if you aren't careful.

